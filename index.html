<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Bus Trip Hisab â€“ Fixed Final (Bulk coach-only extract + omit closed)</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Arial;background:#eef2f5;color:#222}
  .container{max-width:1100px;margin:20px auto;padding:18px}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  .stat{padding:12px;border-radius:8px}
  .jor{border-left:5px solid #1976d2}
  .bijor{border-left:5px solid #f57c00}
  .today{border-left:5px solid #388e3c}
  .all{border-left:5px solid #7b1fa2}
  .lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .trip-item{padding:8px;background:#f9f9f9;border-radius:6px;margin-bottom:6px}
  .trip-code{font-family:monospace;font-weight:700;color:#1976d2}
  button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;cursor:pointer;background:#f6f6f6}
  .main{background:#1976d2;color:#fff;border:none}
  .danger{background:#d32f2f;color:#fff;border:none}
  .copy{background:#2e7d32;color:#fff;border:none}
  textarea,input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:14px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .small{padding:6px 8px;font-size:13px}
  .status{padding:8px;border-radius:6px;background:#e3f2fd;color:#0b5394;margin-top:8px;display:none}
  .status.error{background:#ffebee;color:#b71c1c}
  .note{font-size:13px;color:#666;margin-top:8px}
  @media(max-width:900px){.stats{grid-template-columns:repeat(2,1fr)} .lists{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <h2>ðŸšŒ Bus Trip Hisab â€” Coach-only extractor (omit seats 40/41)</h2>

  <div class="card stats">
    <div class="stat jor"><div style="font-size:13px;color:#555">Jor</div><div id="jorCount" style="font-size:20px;font-weight:700">0</div></div>
    <div class="stat bijor"><div style="font-size:13px;color:#555">Bijor</div><div id="bijorCount" style="font-size:20px;font-weight:700">0</div></div>
    <div class="stat today"><div style="font-size:13px;color:#555">Total (This Date)</div><div id="totalCount" style="font-size:20px;font-weight:700">0</div></div>
    <div class="stat all"><div style="font-size:13px;color:#555">All Time Total</div><div id="allTimeCount" style="font-size:20px;font-weight:700">0</div></div>
  </div>

  <div class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <label style="font-weight:600">Selected Date:</label>
      <input type="date" id="datePicker" />
      <button onclick="goToToday()" class="small">Today</button>
      <div style="margin-left:auto;color:#666;font-size:14px" id="currentDateDisplay"></div>
    </div>
    <div class="status" id="statusBox"></div>
  </div>

  <div class="card lists">
    <div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <h3 style="margin:0">Jor Trips</h3>
        <button class="copy small" onclick="copyList('jor')">Copy Jor</button>
        <button class="small" onclick="clearList('jor')">Clear Jor</button>
      </div>
      <ul id="jorList" style="padding-left:0;list-style:none;margin:0"></ul>
    </div>
    <div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <h3 style="margin:0">Bijor Trips</h3>
        <button class="copy small" onclick="copyList('bijor')">Copy Bijor</button>
        <button class="small" onclick="clearList('bijor')">Clear Bijor</button>
      </div>
      <ul id="bijorList" style="padding-left:0;list-style:none;margin:0"></ul>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="copy main" onclick="copyAll()">ðŸ“‹ Copy Jor + Bijor</button>
      <button class="small danger" onclick="clearCurrentDate()">Clear Current Date</button>
      <button class="small danger" onclick="clearAllData()">Clear ALL Data</button>
    </div>
    <div class="note">Note: Trips with <strong>Seats 40 or 41</strong> are considered <em>bondho</em> and will be omitted from Jor/Bijor lists but kept separately in storage.</div>
  </div>

  <div class="card">
    <strong>Paste Bulk Text (one big dump)</strong>
    <textarea id="bulk" rows="8" placeholder="Paste the full page content here (your sample format) ..."></textarea>
    <div class="controls">
      <button class="main" onclick="processBulk()">Process Bulk (coach-only, omit Seats 40/41)</button>
      <button onclick="processBulkAndShowSummary()">Process + Show Summary</button>
      <button onclick="clearInput()">Clear Input</button>
    </div>
    <div style="font-size:13px;color:#555;margin-top:8px">
      The tool will extract coach numbers like <code>06-PK-MA</code>, <code>01 MA-PK</code>, <code>103 CHA SWK</code>, <code>454-MTB-GPL-GBT</code> and add them as Jor/Bijor based on coach number parity. Closed trips (Seats 40/41) are omitted from lists but saved separately.
    </div>
  </div>

  <div class="card">
    <strong>Add Single Trip</strong>
    <input id="single" placeholder="e.g. SP 806-PK-MA 05:00 AM or 806-PK-MA" />
    <div class="controls">
      <button class="main" onclick="addSingle()">Add</button>
      <button onclick="addSingleAndShow()">Add + Show</button>
    </div>
  </div>

</div>

<script>
/* ---------- state ---------- */
const today = new Date().toISOString().split('T')[0];
let data = JSON.parse(localStorage.getItem('tripDataFinal')) || {}; // do NOT auto-create today's entry
let currentViewDate = today;

/* date picker init */
const datePicker = document.getElementById('datePicker');
const currentDateDisplay = document.getElementById('currentDateDisplay');
datePicker.value = currentViewDate;
datePicker.max = today;
currentDateDisplay.innerText = formatDateDisplay(currentViewDate);

/* status box */
const statusBox = document.getElementById('statusBox');
function showStatus(msg, isError=false){
  statusBox.style.display = 'block';
  statusBox.className = 'status' + (isError ? ' error' : '');
  statusBox.innerText = msg;
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(()=> statusBox.style.display='none',3500);
}

/* ---------- utility: format date ---------- */
function formatDateDisplay(dateStr){
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  } catch(e){ return dateStr; }
}

/* ---------- extractor (more flexible) ---------- */
function extractTripCode(text){
  if(!text) return null;
  text = text.trim();
  let hasSP = false;
  if(/^SP\s+/i.test(text)){
    hasSP = true;
    text = text.replace(/^SP\s+/i,'').trim();
  }

  // Try to capture: leading number and following alphanumeric groups (letters/numbers) separated by space/hyphen/dot
  // Example matches: "06-PK-MA", "01 MA-PK", "454-MTB-GPL-GBT", "103 CHA SWK"
  const m = text.match(/^(\d{1,4})(?:[\s\-\.]+([A-Z0-9][A-Z0-9\-\s\.]*))?/i);
  if(!m) return null;
  const number = m[1];
  let rest = m[2] || '';
  // Clean up rest: remove dots, collapse spaces/hyphens to single hyphen, uppercase
  rest = rest.replace(/\./g,' ').trim().replace(/\s+/g,'-').replace(/-+/g,'-').toUpperCase();
  const code = rest ? `${number}-${rest}` : `${number}`;
  return hasSP ? `SP ${code}` : code;
}

/* ---------- save helpers ---------- */
function save(){ localStorage.setItem('tripDataFinal', JSON.stringify(data)); }

/* Ensure date bucket exists before adding */
function ensureDateBucket(date){
  if(!data[date]) data[date] = { jor: [], bijor: [], closed: [] };
  else {
    if(!data[date].jor) data[date].jor = [];
    if(!data[date].bijor) data[date].bijor = [];
    if(!data[date].closed) data[date].closed = [];
  }
}

/* ---------- add logic ---------- */
function addTripToCurrentDate(text){
  const code = extractTripCode(text);
  if(!code) return { ok:false, reason:'no_code' };

  ensureDateBucket(currentViewDate);

  const numMatch = code.match(/\d+/);
  if(!numMatch) return { ok:false, reason:'no_number' };
  const num = parseInt(numMatch[0],10);
  const side = (num % 2 === 0) ? 'jor' : 'bijor';

  if(data[currentViewDate][side].includes(code)) {
    return { ok:false, reason:'duplicate', code, side };
  }

  data[currentViewDate][side].push(code);
  save();
  render();
  return { ok:true, code, side };
}

/* ---------- NEW: add closed coach (kept separately) ---------- */
function addClosedToCurrentDate(code){
  if(!code) return { ok:false };
  ensureDateBucket(currentViewDate);
  if(!data[currentViewDate].closed.includes(code)){
    data[currentViewDate].closed.push(code);
    save();
    return { ok:true };
  }
  return { ok:false, reason:'duplicate' };
}

/* ---------- bulk processing (coach-only, omit seats 40/41) ---------- */
function processBulk(){
  const raw = document.getElementById('bulk').value;
  if(!raw || raw.trim()===''){ showStatus('Please paste some lines first', true); return; }

  // Split on "Coach No" occurrences (case-insensitive). This yields segments where first line is coach code.
  const parts = raw.split(/Coach No/i);
  let added=0, duplicates=0, errors=0, omittedClosed=0, parsed=0;

  for(const seg of parts){
    const s = seg.trim();
    if(!s) continue; // skip leading text before first Coach No

    // get first non-empty line as coach candidate
    const lines = s.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length===0) continue;
    let coachCandidate = lines[0];

    // normalize candidate: remove trailing periods, extra spaces
    coachCandidate = coachCandidate.replace(/\.+$/,'').trim();

    // extract seats in this segment (look for "Seats" then number)
    let seats = null;
    const seatsMatch1 = s.match(/Seats\s*[:\s]*\r?\n\s*(\d{1,3})/i);
    const seatsMatch2 = s.match(/Seats\s*[:\s]*([0-9]{1,3})/i);
    if(seatsMatch1) seats = parseInt(seatsMatch1[1],10);
    else if(seatsMatch2) seats = parseInt(seatsMatch2[1],10);

    // build normalized coach code (use extractTripCode so formatting matches rest of system)
    const norm = extractTripCode(coachCandidate);
    if(!norm){
      errors++;
      continue;
    }
    parsed++;

    // If seats explicitly 40 or 41 => consider bondho => omit from jor/bijor but save separately
    if(seats === 40 || seats === 41){
      addClosedToCurrentDate(norm);
      omittedClosed++;
      continue;
    }

    // Else add normally
    const res = addTripToCurrentDate(norm);
    if(res.ok) added++;
    else if(res.reason === 'duplicate') duplicates++;
    else errors++;
  }

  document.getElementById('bulk').value = '';

  showStatus(`Parsed ${parsed} coach lines â€” Added: ${added}, Duplicates: ${duplicates}, Omitted(closed): ${omittedClosed}, Ignored errors: ${errors}`);
}

function processBulkAndShowSummary(){ processBulk(); showStatus('Bulk processed'); }

/* ---------- single add ---------- */
function addSingle(){
  const txt = document.getElementById('single').value.trim();
  if(!txt){ showStatus('Enter a trip first', true); return; }
  const res = addTripToCurrentDate(txt);
  if(res.ok){
    document.getElementById('single').value = '';
    showStatus(`Added ${res.code} (${res.side})`);
  } else if(res.reason === 'duplicate'){
    showStatus(`${res.code} already exists (${res.side})`, true);
  } else {
    showStatus('Could not detect coach number', true);
  }
}
function addSingleAndShow(){ addSingle(); }

/* ---------- render ---------- */
function render(){
  currentDateDisplay.innerText = formatDateDisplay(currentViewDate);

  const jList = document.getElementById('jorList');
  const bList = document.getElementById('bijorList');

  const jArr = (data[currentViewDate] ? data[currentViewDate].jor.slice() : []).sort();
  const bArr = (data[currentViewDate] ? data[currentViewDate].bijor.slice() : []).sort();

  jList.innerHTML = jArr.map(t => `<li class="trip-item"><span class="trip-code">${t}</span></li>`).join('') || '<div style="color:#777;font-size:13px">No jor trips</div>';
  bList.innerHTML = bArr.map(t => `<li class="trip-item"><span class="trip-code">${t}</span></li>`).join('') || '<div style="color:#777;font-size:13px">No bijor trips</div>';

  document.getElementById('jorCount').innerText = jArr.length;
  document.getElementById('bijorCount').innerText = bArr.length;
  document.getElementById('totalCount').innerText = jArr.length + bArr.length;

  // all time total (exclude closed if you want; here we count only jor+bijor)
  let all=0;
  Object.keys(data).forEach(d => {
    all += (data[d].jor?.length||0) + (data[d].bijor?.length||0);
  });
  document.getElementById('allTimeCount').innerText = all;
}

/* ---------- copy helpers (clipboard with fallback) ---------- */
function fallbackCopyTextToClipboard(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try{
    document.execCommand('copy');
    document.body.removeChild(ta);
    return true;
  }catch(e){
    document.body.removeChild(ta);
    return false;
  }
}

function copyText(text){
  if(!text) return false;
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>fallbackCopyTextToClipboard(text));
  } else {
    return Promise.resolve(fallbackCopyTextToClipboard(text));
  }
}

/* ---------- copy APIs ---------- */
function copyList(type){
  const arr = data[currentViewDate] ? data[currentViewDate][type] : [];
  if(!arr || arr.length===0){ showStatus('Nothing to copy', true); return; }
  const text = arr.join('\n');
  copyText(text).then(ok => {
    if(ok) showStatus(`Copied ${arr.length} ${type} trips`);
    else showStatus('Copy failed â€” try selecting and copying manually', true);
  });
}

function copyAll(){
  const j = data[currentViewDate] ? data[currentViewDate].jor : [];
  const b = data[currentViewDate] ? data[currentViewDate].bijor : [];
  if((!j || j.length===0) && (!b || b.length===0)){ showStatus('Nothing to copy', true); return; }

  let out = '';
  if(j && j.length) out += 'JOR:\n' + j.join('\n') + '\n\n';
  if(b && b.length) out += 'BIJOR:\n' + b.join('\n');

  copyText(out).then(ok=>{
    if(ok) showStatus('Copied Jor + Bijor');
    else showStatus('Copy failed â€” try selecting and copying manually', true);
  });
}

/* ---------- clear functions ---------- */
function clearList(type){
  if(!data[currentViewDate] || !data[currentViewDate][type] || data[currentViewDate][type].length===0){
    showStatus(`No ${type} trips to clear`, true);
    return;
  }
  if(!confirm(`Clear all ${type} trips for ${currentViewDate}?`)) return;
  data[currentViewDate][type] = [];
  save(); render(); showStatus(`Cleared ${type} trips for ${currentViewDate}`);
}

function clearCurrentDate(){
  if(!data[currentViewDate] || ((data[currentViewDate].jor.length + data[currentViewDate].bijor.length + (data[currentViewDate].closed?.length||0))===0)){
    showStatus('No trips for this date to clear', true); return;
  }
  if(!confirm(`Clear ALL trips for ${currentViewDate}? This will remove ${ (data[currentViewDate].jor.length + data[currentViewDate].bijor.length + (data[currentViewDate].closed?.length||0)) } trips.`)) return;
  delete data[currentViewDate];
  save(); render(); showStatus(`Cleared all trips for ${currentViewDate}`);
}

function clearAllData(){
  let total=0, dates=Object.keys(data).length;
  Object.keys(data).forEach(d => total += (data[d].jor?.length||0)+(data[d].bijor?.length||0)+(data[d].closed?.length||0));
  if(total===0){ showStatus('No data to clear', true); return; }
  if(!confirm(`Clear ALL stored data? (${total} trips across ${dates} dates). This cannot be undone.`)) return;
  data = {};
  save(); render(); showStatus('All data cleared');
}

/* ---------- date navigation ---------- */
function goToToday(){ currentViewDate = today; datePicker.value = today; render(); showStatus('Switched to today'); }

datePicker.addEventListener('change', () => {
  const selected = datePicker.value;
  if(!selected) return;
  if(selected > today){ showStatus('Cannot select future date', true); datePicker.value = currentViewDate; return; }
  currentViewDate = selected;
  render();
});

/* ---------- misc helpers ---------- */
function clearInput(){ document.getElementById('bulk').value = ''; document.getElementById('single').value=''; showStatus('Inputs cleared'); }

/* ---------- initialize UI ---------- */
(function init(){
  datePicker.value = currentViewDate;
  render();
})();
</script>
</body>
</html>
